{% load i18n %}
{% load humanize %}

<!-- Transaction History Modal -->
<div class="modal fade" id="transactionHistoryModal" tabindex="-1" role="dialog" aria-labelledby="transactionHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionHistoryModalLabel">Transaction History</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card-body table-wrapper" style="font-size: 12px">
                            <div class="table-responsive">
                                <table class="table table-sm display" id="transactionTable">
                                    <thead>
                                        <tr class="text-center" style="font-size: 12px">
                                            <th>{% trans "Transaction Number" %}</th>
                                            <th>{% trans "Account Number" %}</th>
                                            <th>{% trans "Amount" %}</th>
                                            <th>{% trans "Date" %}</th>
                                            <th>{% trans "Transfer Code" %}</th>
                                            <th>{% trans "Status" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inTransactionTableBody" class="text-center">
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var table = $('#transactionTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            order: false,
        });

        $('#transactionHistoryModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var accountNo = button.data('account'); // Extract info from data-* attributes

            var modal = $(this);
            modal.find('.modal-title').text('Transaction History - ' + accountNo);

            // Make an AJAX call to fetch the transaction history
            $.ajax({
                url: '{% url "record_book_report" %}', // Replace with your actual URL
                method: 'POST',
                data: { account_no: accountNo },
                success: function(data) {
                    var tbody = $('#transactionTable tbody');
                    tbody.empty(); // Clear existing data
                    transactions = data.transactions
                    console.log(transactions)
                    $.each(transactions, function(index, item) {
                        var amountClass = item.transaction_type === 'IN' ? 'text-success' : 'text-danger';
                        var row = '<tr class="text-center">';
                        row += '<td>' + item.transaction_number + '</td>';
                        row += '<td>' + item.account_number + '</td>';
                        row += '<td class="' + amountClass + '">' + item.amount.toLocaleString() + '</td>';
                        row += '<td>' + item.transaction_date + '</td>';
                        row += '<td>' + item.transfer_code + '</td>';
                        row += '<td>' + item.status + '</td>';
                        row += '</tr>';
                        tbody.append(row);
                    });

                    // Reinitialize DataTable
                    table.clear().rows.add($('#transactionTable tbody tr')).draw();
                },
                error: function() {
                    modal.find('#inTransactionTableBody').html('<p>An error occurred while fetching the transaction history.</p>');
                }
            });
        });
    });
</script>
