{% load i18n %}
{% load humanize %}
<!-- Transaction History Modal -->
<div class="modal fade" id="transactionHistoryModal" tabindex="-1" role="dialog" aria-labelledby="transactionHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionHistoryModalLabel">Transaction History</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" id="search-form" action="{% url 'record_book_report'%}">
                    <div class="row">
                        <div class="col-md-5 col-sm-12">
                            <label for="start_datetime">{% trans "Start Date" %}</label>
                            <input type="datetime-local" id="start_datetime" name="start_datetime" class="form-control input-sm" value="{{ start_date }}" />
                        </div>
                        <div class="col-md-5 col-sm-12">
                            <label for="end_datetime">{% trans "End Date" %}</label>
                            <input type="datetime-local" id="end_datetime" name="end_datetime" class="form-control input-sm" value="{{ end_date }}" />
                        </div>
                        <div class="col-md-2 col-sm-12 text-right">
                            <input type="hidden" name="in_page" value="{{ in_page_obj.number }}">
                            <input type="hidden" name="out_page" value="{{ out_page_obj.number }}">
                            <button type="submit" class="btn btn-primary">{% trans "Search" %}</button>
                        </div>
                    </div>
                </form>
                <div class="row d-flex justify-content-between same-height">
                    <div class="col-md-6">
                        <div class="card-body table-wrapper" style="font-size: 12px">
                            <div class="table-responsive">
                                <table class="table table-sm display">
                                    <thead>
                                        <tr class="text-center" style="font-size: 12px">
                                            <th></th>
                                            <th>{% trans "Account Number" %}</th>
                                            <th>{% trans "Amount" %}</th>
                                            <th>{% trans "Date" %}</th>
                                            <th>{% trans "Transfer Code" %}</th>
                                            <th>{% trans "Status" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inTransactionTableBody" class="text-center">
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination for IN transactions -->
                            {% if in_page_obj%}
                            <div class="d-flex justify-content-center">
                                <nav aria-label="In transactions page navigation">
                                    <ul class="pagination" id="in-pagination">
                                        {% if in_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="#" data-page="{{ in_page_obj.previous_page_number }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                        {% for num in in_page_obj.paginator.page_range %}
                                            {% if num > in_page_obj.number|add:'-3' and num < in_page_obj.number|add:'3' %}
                                                {% if in_page_obj.number == num %}
                                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="#" data-page="{{ num }}">{{ num }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if in_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="#" data-page="{{ in_page_obj.next_page_number }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                            {% endif %}
                        </div>
                    </div>
            
                    <div class="col-md-6">
                        <div class="card-body table-wrapper" style="font-size: 12px">
                            <div class="table-responsive">
                                <table class="table table-sm display">
                                    <thead>
                                        <tr class="text-center" style="font-size: 12px">
                                            <th></th>
                                            <th>{% trans "Account Number" %}</th>
                                            <th>{% trans "Amount" %}</th>
                                            <th>{% trans "Date" %}</th>
                                            <th>{% trans "Status" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="outTransactionTableBody" class="text-center">
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination for OUT transactions -->
                            {% if in_page_obj%}
                            <div class="d-flex justify-content-center">
                                <nav aria-label="Out transactions page navigation">
                                    <ul class="pagination" id="out-pagination">
                                        {% if out_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="#" data-page="{{ out_page_obj.previous_page_number }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                        {% for num in out_page_obj.paginator.page_range %}
                                            {% if num > out_page_obj.number|add:'-3' and num < out_page_obj.number|add:'3' %}
                                                {% if out_page_obj.number == num %}
                                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="#" data-page="{{ num }}">{{ num }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if out_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="#" data-page="{{ out_page_obj.next_page_number }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        function formatDateTime(input) {
            const date = new Date(input);

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = date.getFullYear();

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function toggleDetailsRow(rowId) {
            const detailsRow = $('#details-' + rowId);
            const icon = $('#icon-' + rowId).find('i');

            if (detailsRow.is(':visible')) {
                detailsRow.hide();
                icon.removeClass('fa-minus-circle').addClass('fa-plus-circle').css('color', 'green');
            } else {
                detailsRow.show();
                icon.removeClass('fa-plus-circle').addClass('fa-minus-circle').css('color', 'red');
            }
        }

        function bindRowClickEvents() {
            $('.main-row').off('click').on('click', function() {
                const rowId = $(this).data('transactionNumber');
                toggleDetailsRow(rowId);
            });
        }

        function updateTotals(totalIn, totalOut) {
            $('#total-in-amount').text(totalIn.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
            $('#total-out-amount').text(totalOut.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        }

        function fetchData(url, callback) {
            $.ajax({
                url: url,
                method: 'POST',
                dataType: 'json',
                success: function(data) {
                    callback(data);
                    updateTotals(data.total_in_amount, data.total_out_amount);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        }

        function updateTableData(tableId, data) {
            const tableBody = $('#' + tableId);
            tableBody.empty();
            data.forEach((item) => {
                const row = $('<tr>')
                    .addClass('main-row text-center')
                    .attr('data-transaction-number', item.transaction_number)
                    .attr('style', 'font-size: 12px;');

                row.append(`<td><span class="toggle-icon" id="icon-${item.transaction_number}"><i class="fa fa-plus-circle" style="color: green;"></i></span></td>`);
                row.append(`<td>${item.account_number}</td>`);
                row.append(`<td class="${tableId === 'inTransactionTableBody' ? 'text-success' : 'text-danger'}">${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`);
                row.append(`<td>${formatDateTime(item.transaction_date)}</td>`);
                if (tableId === 'inTransactionTableBody') {
                    row.append(`<td>${item.transfer_code}</td>`);
                }
                row.append(`<td>${item.status}</td>`);
                tableBody.append(row);

                const detailsRow = $('<tr>')
                    .addClass('hidden-row')
                    .attr('id', `details-${item.transaction_number}`)
                    .attr('style', 'display: none;');

                detailsRow.append(`<td colspan="6"><div><strong>{% trans "Transaction Number" %}:</strong> ${item.transaction_number}<br><strong>{% trans "Memo" %}:</strong> ${item.description}</div></td>`);
                tableBody.append(detailsRow);
            });

            bindRowClickEvents();
        }

        function handlePaginationClick(event, paginationId) {
            event.preventDefault();
            const page = $(this).data('page');
            if (page) {
                const url = new URL(window.location.href);
                const params = new URLSearchParams(url.search);

                // Preserve the current search parameters
                params.set('in_page', paginationId === 'in-pagination' ? page : params.get('in_page') || 1);
                params.set('out_page', paginationId === 'out-pagination' ? page : params.get('out_page') || 1);

                url.search = params.toString();
                fetchData(url.toString(), function(data) {
                    updateTableData('inTransactionTableBody', data.in_transactions);
                    updateTableData('outTransactionTableBody', data.out_transactions);
                    updatePagination('in-pagination', data.in_page, data.in_num_pages);
                    updatePagination('out-pagination', data.out_page, data.out_num_pages);
                });

                history.pushState({}, '', url.toString());
            }
        }

        function updatePagination(paginationId, currentPage, numPages) {
            const pagination = $('#' + paginationId);
            pagination.empty();
            if (currentPage > 1) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `);
            } else {
                pagination.append(`
                    <li class="page-item disabled">
                        <span class="page-link" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </span>
                    </li>
                `);
            }
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(numPages, currentPage + 2); i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }
            if (currentPage < numPages) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `);
            } else {
                pagination.append(`
                    <li class="page-item disabled">
                        <span class="page-link" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </span>
                    </li>
                `);
            }
            pagination.find('a.page-link').on('click', function(event) {
                handlePaginationClick.call(this, event, paginationId);
            });
        }

        $('#search-form').on('submit', function(event) {
            event.preventDefault();
            const url = new URL(window.location.href);
            const params = new URLSearchParams($(this).serialize());

            // Preserve pagination parameters
            const inPage = params.get('in_page') || 1;
            const outPage = params.get('out_page') || 1;
            params.set('in_page', inPage);
            params.set('out_page', outPage);

            fetchData(`${url.pathname}?${params.toString()}`, function(data) {
                updateTableData('inTransactionTableBody', data.in_transactions);
                updateTableData('outTransactionTableBody', data.out_transactions);
                updatePagination('in-pagination', data.in_page, data.in_num_pages);
                updatePagination('out-pagination', data.out_page, data.out_num_pages);
            });

            history.pushState({}, '', `${url.pathname}?${params.toString()}`);
        });

        // Bind the initial row click events
        bindRowClickEvents();

        // Initial pagination binding
        $('#in-pagination').find('a.page-link').on('click', function(event) {
            handlePaginationClick.call(this, event, 'in-pagination');
        });
        $('#out-pagination').find('a.page-link').on('click', function(event) {
            handlePaginationClick.call(this, event, 'out-pagination');
        });

        $('#transactionHistoryModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var accountNo = button.data('account'); // Extract info from data-* attributes
            
            var modal = $(this);
            modal.find('.modal-title').text('Transaction History - ' + accountNo);

            // Make an AJAX call to fetch the transaction history
            $.ajax({
                url: '{% url "record_book_report" %}', // Replace with your actual URL
                method: 'POST',
                data: { account_no: accountNo },
                success: function(data) {
                    console.log(data);
                    updateTableData('inTransactionTableBody', data.in_transactions);
                    updateTableData('outTransactionTableBody', data.out_transactions);
                },
                error: function() {
                    modal.find('#transactionHistoryContent').html('<p>An error occurred while fetching the transaction history.</p>');
                }
            });
        });
    });
</script>
