{% extends "layout/layout.html" %}
{% load humanize %}
{% block title %}List Payout{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="card mb-3 col-md-12 col-sm-12">
            <div class="card-body">
                <h5 class="card-title">List payout</h5>
                <table class="table table-borderless" id="payoutTable">
                    <thead>
                    <tr>
                        <th scope="col">CID</th>
                        <th scope="col">Order No</th>
                        <th scope="col">Order ID</th>
                        <th scope="col">Money</th>
                        <th scope="col">Created At</th>
                        <th scope="col">Status</th>
                        <th scope="col">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in page_obj %}
                    <tr>
                        <th>{{ item.scode }}</th>
                        <td>{{ item.orderno }}</td>
                        <td>{{ item.orderid }}</td>
                        <td>{{ item.money|intcomma }} đ</td>
                        <td>{{ item.created_at }}</td>
                        <td>
                            {% if item.status %}
                            <span class="badge bg-success">Done</span>
                            {% else %}
                            <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not item.status %}
                            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#payModal" data-item-id="{{ item.id }}">Pay</button>
                            <!-- <button class="btn btn-sm btn-success done-btn" data-item-id="{{ item.id }}">Done</button> -->
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div class="pagination">
                    <span class="step-links">
                        {% if page_obj.has_previous %}
                        <a href="?page=1">&laquo; first</a>
                        <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                        {% endif %}

                        <span class="current">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                        </span>

                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}">next</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div><!-- End Card with an image on left -->
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="payModal" tabindex="-1" aria-labelledby="payModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payModalLabel">Payout Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
                <p><strong>Order No:</strong> <span id="modalOrderNo"></span></p>
                <p><strong>Account No:</strong> <span id="modalAccountNo"></span></p>
                <p><strong>Bank Name:</strong> <span id="modalBankName"></span></p>
                <p><strong>Account Name:</strong> <span id="modalAccountName"></span></p>
                <p><strong>Money:</strong> <span id="modalMoney"></span> đ</p>
                <img id="modalQrImage" class="img-fluid rounded-start" alt="QR Code">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success done-btn-modal" data-item-id="">Done</button>
                <button type="button" class="btn btn-danger">Report</button>
                <button type="button" class="btn btn-danger">Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden JSON data -->
<script type="application/json" id="items-data">
    {{ items_json|safe }}
</script>
{% endblock %}
{% block script %}
<!-- Include jQuery and SweetAlert2 CSS and JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    $(document).ready(function() {
        var itemsData = JSON.parse($('#items-data').text());
        var payModal = $('#payModal');
        payModal.on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);
            var itemId = button.data('item-id');
            var item = itemsData.find(item => item.id == itemId);

            $('#modalOrderId').text(item.orderid);
            $('#modalOrderNo').text(item.orderno);
            $('#modalAccountNo').text(item.accountno);
            $('#modalBankName').text(item.bankcode);
            $('#modalAccountName').text(item.accountname.toUpperCase());
            $('#modalMoney').text(item.money.toLocaleString());
            $('#modalQrImage').attr('src', `https://vietqr.me/api/generate/${item.bankcode}/${item.accountno}/${item.accountname}?amount=${item.money}&memo=Z${item.accountname}&is_mask=0&bg=7`);
            
            $('.done-btn-modal').data('item-id', itemId);
        });

        $('.done-btn-modal').click(function() {
            var itemId = $(this).data('item-id');
            const csrftoken = getCookie('csrftoken');
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to mark this payout as done?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "{% url 'update_payout' %}",
                        type: 'POST',
                        data: JSON.stringify({ id: itemId }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        success: function(data) {
                            if (data.success) {
                                Swal.fire(
                                    'Marked!',
                                    'The payout has been marked as done.',
                                    'success'
                                ).then(() => {
                                    location.reload();  // Reload the page to reflect the changes
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    'An error occurred.',
                                    'error'
                                );
                            }
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}
