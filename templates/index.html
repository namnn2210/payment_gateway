{% extends "layout/layout.html" %}
{% load humanize %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <h6 class="balance-total"><span class="text-success">Ä‘</span></h6>
                            <span class="text-success small pt-1 fw-bold">+0</span> / <span
                                class="text-danger small pt-1 fw-bold">-0</span> <span
                                class="text-muted small pt-2 ps-1">Today</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">BANK</span> <span class="card-title text-success"> IN </span> - <span class="total-in"></span>

                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <table class="table table-borderless table-sm">
                                <thead>
                                    <tr>
                                        <th scope="col">Account Number</th>
                                        <th scope="col">Balance</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-in">
                                </tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">BANK</span> <span class="card-title text-danger"> OUT </span> - <span class="total-out"></span>

                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <table class="table table-borderless table-sm">
                                <thead>
                                    <tr>
                                        <th scope="col">Account Number</th>
                                        <th scope="col">Balance</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-out">
                                </tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">Latest transaction <span class="text-success">IN</span> history</h5>
                    <!-- Small tables -->
                    <table class="table table-sm table-in">
                        <thead>
                            <tr class="text-center" style="font-size: 12px">
                                <th>Account Number</th>
                                <th>Reference Number</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Memo</th>
                            </tr>
                        </thead>
                        <tbody class="text-center" id="transaction-table-body" style="font-size: 12px">
                            <tr>
                                <td colspan="5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div><!-- End Border spinner -->
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div><!-- End Recent Sales -->
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">Latest transaction <span class="text-danger">OUT</span> history</h5>
                    <!-- Small tables -->
                    <table class="table table-sm table-out">
                        <thead>
                            <tr class="text-center" style="font-size: 12px">
                                <th>Account Number</th>
                                <th>Reference Number</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Memo</th>
                            </tr>
                        </thead>
                        <tbody class="text-center" id="transaction-table-body" style="font-size: 12px">
                            <tr>
                                <td colspan="5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div><!-- End Border spinner -->
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div><!-- End Recent Sales -->
    </div>
</div>
</div>
{% endblock %}
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function fetchLatestTransactions() {
            fetch('{% url "update_transaction_history" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBodyIn = document.querySelector('table.table-in tbody');
                    if (!tableBodyIn) {
                        console.error('Table body element not found');
                        return;
                    }
                    tableBodyIn.innerHTML = ''; // Clear existing table rows
                    data.data.in.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.account}</td>
                            <td>${transaction.transaction_number}</td>
                            <td class="text-success">${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.active_datetime}</td>
                            <td>${transaction.description}</td>
                        `;
                        tableBodyIn.appendChild(row);
                    });

                    const tableBodyOut = document.querySelector('table.table-out tbody');
                    if (!tableBodyOut) {
                        console.error('Table body element not found');
                        return;
                    }
                    tableBodyOut.innerHTML = ''; // Clear existing table rows
                    data.data.out.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.account}</td>
                            <td>${transaction.transaction_number}</td>
                            <td class="text-danger">${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.active_datetime}</td>
                            <td>${transaction.description}</td>
                        `;
                        tableBodyOut.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                });
        };

        function fetchBalance() {
            fetch('{% url "update_balance" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {

                    let totalIn = 0;
                    let totalOut = 0;
                    const spanTotalIn = document.querySelector('span.total-in');
                    const spanTotalOut = document.querySelector('span.total-out');

                    const tableBodyIn = document.querySelector('table.table-borderless tbody.tbody-in');
                    if (!tableBodyIn) {
                        console.error('Table body element not found');
                        return;
                    }

                    const tableBodyOut = document.querySelector('table.table-borderless tbody.tbody-out');
                    if (!tableBodyOut) {
                        console.error('Table body element not found');
                        return;
                    }

                    tableBodyIn.innerHTML = '';
                    tableBodyOut.innerHTML = '';

                    data.data.balance.forEach(bank => {
                        const row = document.createElement('tr');
                        if (bank.bank_type === 'IN') {
                            accountClass = 'account-balance-in'
                        }
                        else {
                            accountClass = 'account-balance-out'
                        }
                        row.innerHTML = `
                            <th>${bank.account_number}</td>
                            <td><b class=${accountClass}>${bank.balance.toLocaleString()} <span class="text-success">Ä‘</span></b></td>
                        `;
                        if (bank.bank_type === 'IN') {
                            totalIn += bank.balance
                            tableBodyIn.appendChild(row);
                        }
                        else {
                            totalOut += bank.balance
                            tableBodyOut.appendChild(row);
                        }

                    });

                    spanTotalIn.innerHTML = totalIn.toLocaleString() + ' <span class="text-success">Ä‘</span> ';
                    spanTotalOut.innerHTML = totalOut.toLocaleString() + ' <span class="text-danger">Ä‘</span> ';

                    const balanceTotal = document.querySelector('.balance-total');
                    if (!balanceTotal) {
                        console.error('Element not found');
                        return;
                    }
                    balanceTotal.innerHTML = (totalIn + totalOut).toLocaleString() + ' <span class="text-success">Ä‘</span> ';
                })

                .catch(error => {
                    console.error('Error fetching balance:', error);
                });
        };

        // Fetch transactions when the page loads
        fetchLatestTransactions();
        fetchBalance();

        // Optionally, set an interval to fetch the data periodically
        setInterval(fetchLatestTransactions, 15000); // Fetch every 30 seconds
        setInterval(fetchBalance, 15000);
    });
</script>
{% endblock %}