{% extends "layout/layout.html" %}
{% load humanize %}
{% load i18n %}
{% block title %}{% trans "Dashboard" %}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-sm-6">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-bullseye"></i>
                        </div>
                        <div class="ps-3">
                            <h6 class="balance-total"><span class="text-success"></span></h6>
                            <span class="text-success small pt-1 fw-bold total-in">+0</span> / <span class="text-danger small pt-1 fw-bold total-out">-0</span> <span class="text-muted small pt-2 ps-1">{% trans "Today" %}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-sm-6">
            <div class="card info-card revenue-card">
                <div class="card-body text-center mt-4 align-items-center">
                    <button type="button" class="btn btn-primary create-deposit-btn" data-bs-toggle="modal" data-bs-target="#createDepositModal">{% trans "Create Deposit Request" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">{% trans "BANK" %}</span> <span class="card-title text-success"> {% trans "IN" %} </span> - <b class="total-in"></b>
                    <div class="d-flex align-items-center">
                        <div class="table-responsive">
                            <table class="table table-sm" style="font-size: 12px">
                                <thead>
                                    <tr style="font-size: 12px">
                                        <th>#</th>
                                        <th>{% trans "BANK" %}</th>
                                        <th>{% trans "Account Number" %}</th>
                                        <th>{% trans "Account Name" %}</th>
                                        <th>{% trans "Balance" %}</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-in"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">{% trans "BANK" %}</span> <span class="card-title text-danger"> {% trans "OUT" %} </span> - <b class="total-out"></b>
                    <div class="d-flex align-items-center">
                        <div class="table-responsive">
                            <table class="table table-sm" style="font-size: 12px">
                                <thead>
                                    <tr style="font-size: 12px">
                                        <th>#</th>
                                        <th>{% trans "BANK" %}</th>
                                        <th>{% trans "Account Number" %}</th>
                                        <th>{% trans "Account Name" %}</th>
                                        <th>{% trans "Balance" %}</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-out"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Latest transaction" %} <span class="text-success">{% trans "IN" %}</span> {% trans "history" %}</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-in">
                            <thead>
                                <tr class="text-center" style="font-size: 12px">
                                    <th>{% trans "Account Number" %}</th>
                                    <th>{% trans "Reference Number" %}</th>
                                    <th>{% trans "Amount" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Memo" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" style="font-size: 12px">
                                <tr>
                                    <td colspan="5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Latest transaction" %} <span class="text-danger">{% trans "OUT" %}</span> {% trans "history" %}</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-out">
                            <thead>
                                <tr class="text-center" style="font-size: 12px">
                                    <th>{% trans "Account Number" %}</th>
                                    <th>{% trans "Reference Number" %}</th>
                                    <th>{% trans "Amount" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Memo" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" style="font-size: 12px">
                                <tr>
                                    <td colspan="5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createDepositModal" aria-labelledby="createDepositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createDepositModalcreateDepositModalLabel">{% trans "Deposit Details" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row">
                <form id="depositForm" method="post" action="{% url 'employee_deposit' %}">
                    {% csrf_token %}
                    <div class="col-md-12 col-sm-12">
                        <label for="deposit">{% trans 'Amount' %}</label>
                        <input type="number" id="deposit" name="deposit" class="form-control" required>
                    </div>
                    <div class="col-md-12 col-sm-12 mt-2">
                        <label for="bank">{% trans 'Bank Account' %}</label>
                        <select class="form-select" id="bank" name="bank" required>
                            {% for bank_account in list_user_bank%}
                                <option value="{{bank_account.id}}">{{bank_account.account_number}} - {{bank_account.bank_name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success done-btn-modal" data-item-id="">{% trans "Done" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fetchData = async (url, options = {}) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`Network response was not ok ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        };

        const updateTransactionTable = (transactions, tableSelector) => {
            const tableBody = document.querySelector(tableSelector);
            if (!tableBody) {
                console.error('Table body element not found');
                return;
            }
            tableBody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${transaction.account_number}</td>
                    <td>${transaction.transaction_number}</td>
                    <td class="${transaction.amount > 0 ? 'text-success' : 'text-danger'}">${transaction.amount.toLocaleString()}</td>
                    <td>${transaction.transaction_date}</td>
                    <td>${transaction.description}</td>
                    <td>${transaction.status || ''}</td>
                </tr>
            `).join('');
        };

        const updateBalanceTable = (balances, tableSelector, totalSelector, totalType) => {
            const tableBody = document.querySelector(tableSelector);
            const totalElement = document.querySelector(totalSelector);
            if (!tableBody || !totalElement) {
                console.error('Table or total element not found');
                return;
            }

            let total = 0;
            tableBody.innerHTML = balances.map((balance, index) => {
                total += balance.balance;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${balance.bank_name}</td>
                        <td>${balance.account_number}</td>
                        <td>${balance.account_name}</td>
                        <td class="${totalType}">${balance.balance.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
            totalElement.innerHTML = `${total.toLocaleString()} <span class="${totalType}"></span>`;
        };

        const updateAmountToday = (data) => {
            const totalInElem = document.querySelector('.total-in');
            const totalOutElem = document.querySelector('.total-out');

            if (totalInElem) totalInElem.innerHTML = `+${data.in.toLocaleString()} <span class="text-success"></span>`;
            else console.error('Total In element not found');

            if (totalOutElem) totalOutElem.innerHTML = `-${data.out.toLocaleString()} <span class="text-danger"></span>`;
            else console.error('Total Out element not found');
        };

        const fetchLatestTransactions = async () => {
            const data = await fetchData('{% url "update_transaction_history" %}');
            if (data) {
                updateTransactionTable(data.data.in, 'table.table-in tbody');
                updateTransactionTable(data.data.out, 'table.table-out tbody');
            }
        };

        const fetchBalance = async () => {
            const data = await fetchData('{% url "update_balance" %}');
            if (data) {
                const balancesIn = data.data.balance.filter(bank => bank.bank_type === 'IN');
                const balancesOut = data.data.balance.filter(bank => bank.bank_type === 'OUT');
                updateBalanceTable(balancesIn, 'table.table-sm tbody.tbody-in', 'b.total-in', 'text-success');
                updateBalanceTable(balancesOut, 'table.table-sm tbody.tbody-out', 'b.total-out', 'text-danger');

                const balanceTotalElem = document.querySelector('.balance-total');
                if (balanceTotalElem) {
                    const totalBalance = balancesIn.reduce((sum, bank) => sum + bank.balance, 0) +
                                        balancesOut.reduce((sum, bank) => sum + bank.balance, 0);
                    balanceTotalElem.innerHTML = `${totalBalance.toLocaleString()} <span class="text-success"></span>`;
                } else {
                    console.error('Balance total element not found');
                }
            }
        };

        const fetchAmountToday = async () => {
            const data = await fetchData('{% url "get_amount_today" %}');
            if (data) updateAmountToday(data.data);
        };

        $(document).on('click', '.done-btn-modal', function () {
            const form = document.getElementById('depositForm');
            form.submit();
        });

        fetchLatestTransactions();
        fetchBalance();
        fetchAmountToday();

        setInterval(fetchLatestTransactions, 15000);
        setInterval(fetchBalance, 15000);
        setInterval(fetchAmountToday, 15000);
    });

</script>
{% endblock %}