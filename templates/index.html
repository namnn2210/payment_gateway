{% extends "layout/layout.html" %}
{% load humanize %}
{% load i18n %}
{% block title %}{% trans "Dashboard" %}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <h6 class="balance-total"><span class="text-success">đ</span></h6>
                            <span class="text-success small pt-1 fw-bold total-in">+0</span> / <span
                                class="text-danger small pt-1 fw-bold total-out">-0</span> <span
                                class="text-muted small pt-2 ps-1">{% trans "Today" %}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">{% trans "BANK" %}</span> <span class="card-title text-success"> {% trans "IN" %} </span> - <b class="total-in"></b>

                    <div class="d-flex align-items-center">

                        <div class="table-responsive">
                            <table class="table table-sm" style="font-size: 12px">
                                <thead>
                                    <tr style="font-size: 12px">
                                        <th>#</th>
                                        <th>{% trans "BANK" %}</th>
                                        <th>{% trans "Account Number" %}</th>
                                        <th>{% trans "Account Name" %}</th>
                                        <th>{% trans "Balance" %}</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-in"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-4 col-md-6 col-sm-12">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <span class="card-title">{% trans "BANK" %}</span> <span class="card-title text-danger"> {% trans "OUT" %} </span> - <b class="total-out"></b>
                    <div class="d-flex align-items-center">

                        <div class="table-responsive">
                            <table class="table  table-sm" style="font-size: 12px">
                                <thead>
                                    <tr style="font-size: 12px">
                                        <th>#</th>
                                        <th>{% trans "BANK" %}</th>
                                        <th>{% trans "Account Number" %}</th>
                                        <th>{% trans "Account Name" %}</th>
                                        <th>{% trans "Balance" %}</th>
                                    </tr>
                                </thead>
                                <tbody class="tbody-out">
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">{% trans "Latest transaction" %} <span class="text-success">{% trans "IN" %}</span> {% trans "history" %}</h5>
                    <!-- Small tables -->
                    <div class="table-responsive">
                        <table class="table table-sm table-in">
                            <thead>
                                <tr class="text-center" style="font-size: 12px">
                                    <th>{% trans "Account Number" %}</th>
                                    <th>{% trans "Reference Number" %}</th>
                                    <th>{% trans "Amount" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Memo" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="transaction-table-body" style="font-size: 12px">
                                <tr>
                                    <td colspan="5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div><!-- End Border spinner -->
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div><!-- End Recent Sales -->
        <div class="col-md-6 col-sm-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">{% trans "Latest transaction" %} <span class="text-danger">{% trans "OUT" %}</span> {% trans "history" %}</h5>
                    <!-- Small tables -->
                    <div class="table-responsive">
                        <table class="table table-sm table-out">
                            <thead>
                                <tr class="text-center" style="font-size: 12px">
                                    <th>{% trans "Account Number" %}</th>
                                    <th>{% trans "Reference Number" %}</th>
                                    <th>{% trans "Amount" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Memo" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="transaction-table-body" style="font-size: 12px">
                                <tr>
                                    <td colspan="5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div><!-- End Border spinner -->
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div><!-- End Recent Sales -->
    </div>
</div>
</div>
{% endblock %}
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function fetchLatestTransactions() {
            fetch('{% url "update_transaction_history" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBodyIn = document.querySelector('table.table-in tbody');
                    if (!tableBodyIn) {
                        console.error('Table body element not found');
                        return;
                    }
                    tableBodyIn.innerHTML = ''; // Clear existing table rows
                    data.data.in.forEach(transaction => {
                        const row = document.createElement('tr');
                        var transactionStatus = ''
                        if (transaction.status === 'Failed') {
                            transactionStatus = 'Failed'
                        }
                        else if (transaction.status === 'Success') {
                            transactionStatus = 'Success'
                        }
                        else {
                            transactionStatus = ''
                        }
                        row.innerHTML = `
                            <td>${transaction.account_number}</td>
                            <td>${transaction.transaction_number}</td>
                            <td class="text-success">${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.transaction_date}</td>
                            <td>${transaction.description}</td>
                            <td>${transactionStatus}</td>
                        `;
                        tableBodyIn.appendChild(row);
                    });

                    const tableBodyOut = document.querySelector('table.table-out tbody');
                    if (!tableBodyOut) {
                        console.error('Table body element not found');
                        return;
                    }
                    tableBodyOut.innerHTML = ''; // Clear existing table rows
                    data.data.out.forEach(transaction => {
                        const row = document.createElement('tr');
                        if (transaction.status === 'Failed') {
                            transactionStatus = 'Failed'
                        }
                        else if (transaction.status === 'Success') {
                            transactionStatus = 'Success'
                        }
                        else {
                            transactionStatus = ''
                        }
                        row.innerHTML = `
                            <td>${transaction.account_number}</td>
                            <td>${transaction.transaction_number}</td>
                            <td class="text-danger">${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.transaction_date}</td>
                            <td>${transaction.description}</td>
                            <td>${transactionStatus}</td>
                        `;
                        tableBodyOut.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                });
        };

        function fetchBalance() {
            fetch('{% url "update_balance" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {

                    let totalIn = 0;
                    let totalOut = 0;
                    let indexIn = 0;
                    let indexOut = 0;
                    const spanTotalIn = document.querySelector('b.total-in');
                    const spanTotalOut = document.querySelector('b.total-out');

                    const tableBodyIn = document.querySelector('table.table-sm tbody.tbody-in');
                    if (!tableBodyIn) {
                        console.error('Table body element not found');
                        return;
                    }

                    const tableBodyOut = document.querySelector('table.table-sm tbody.tbody-out');
                    if (!tableBodyOut) {
                        console.error('Table body element not found');
                        return;
                    }

                    tableBodyIn.innerHTML = '';
                    tableBodyOut.innerHTML = '';

                    data.data.balance.forEach((bank,index) => {
                        const row = document.createElement('tr');
                        if (bank.bank_type === 'IN') {
                            accountClass = 'account-balance-in';
                            indexIn += 1;
                            row.innerHTML = `
                                <td>${indexIn}</td>
                                <td>${bank.bank_name}</td>
                                <td>
                                    ${bank.account_number}
                                </td>
                                <td>${bank.account_name}</td>
                                <td><span class=${accountClass}>${bank.balance.toLocaleString()} <span class="text-success">đ</span></span></td>
                            `;
                            totalIn += bank.balance
                            tableBodyIn.appendChild(row);
                        }
                        else {
                            accountClass = 'account-balance-out';
                            indexOut += 1;
                            row.innerHTML = `
                                <td>${indexOut}</td>
                                <td>${bank.bank_name}</td>
                                <td>
                                    ${bank.account_number}
                                </td>
                                <td>${bank.account_name}</td>
                                <td><span class=${accountClass}>${bank.balance.toLocaleString()} <span class="text-danger">đ</span></span></td>
                            `;
                            totalOut += bank.balance
                            tableBodyOut.appendChild(row);
                        }

                    });

                    spanTotalIn.innerHTML = totalIn.toLocaleString() + ' <span class="text-success">đ</span> ';
                    spanTotalOut.innerHTML = totalOut.toLocaleString() + ' <span class="text-danger">đ</span> ';

                    const balanceTotal = document.querySelector('.balance-total');
                    if (!balanceTotal) {
                        console.error('Element not found');
                        return;
                    }
                    balanceTotal.innerHTML = (totalIn + totalOut).toLocaleString() + ' <span class="text-success">đ</span> ';
                })

                .catch(error => {
                    console.error('Error fetching balance:', error);
                });
        };

        function fetchAmountToday() {
            fetch('{% url "get_amount_today" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    const totalInElem = document.querySelector('.total-in');
                    const totalOutElem = document.querySelector('.total-out');
                    
                    if (totalInElem) {
                        totalInElem.innerHTML = `+${data.data.in.toLocaleString()} <span class="text-success">đ</span>`;
                    } else {
                        console.error('Total In element not found');
                    }

                    if (totalOutElem) {
                        totalOutElem.innerHTML = `-${data.data.out.toLocaleString()} <span class="text-danger">đ</span>`;
                    } else {
                        console.error('Total Out element not found');
                    }
                })
                .catch(error => {
                    console.error('Error fetching amount:', error);
                });
        };



        // Fetch transactions when the page loads
        fetchLatestTransactions();
        fetchBalance();
        fetchAmountToday();

        // Optionally, set an interval to fetch the data periodically
        setInterval(fetchLatestTransactions, 15000); // Fetch every 30 seconds
        setInterval(fetchBalance, 15000);
        setInterval(fetchAmountToday, 15000);
    });
</script>
{% endblock %}