{% extends "layout/layout.html" %}
{% load humanize %}
{% load i18n %}
{% block title %}{% trans "Record Book" %}{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}
{% block content %}
<style>
    .table-wrapper {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .table-wrapper h6 {
        text-align: center;
        margin-bottom: 10px;
    }

    .totals-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
        font-weight: bold;
    }

    .totals-container div {
        margin-bottom: 10px;
    }

    .same-height {
        display: flex;
        flex-wrap: wrap;
    }

    .same-height > .col-md-6 {
        display: flex;
        flex-direction: column;
    }

    .same-height .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .same-height .table-responsive {
        flex-grow: 1;
    }
    .collapse-row td {
        text-align: left;
    }
</style>
<div class="container-fluid">
    <h3 class="card-title" style="font-size: 13px;">{% trans "Record Book" %}</h3>
    <form method="get" id="search-form">
        <div class="row">
            <div class="col-md-4 col-sm-12">
                <label for="search_box">{% trans "Search" %}</label>
                <input type="text" id="search_box" name="search" class="form-control input-sm" placeholder="{% trans 'Search everything here...' %}" value="{{ search_query }}" />
            </div>
            <div class="col-md-4 col-sm-12">
                <label for="start_datetime">{% trans "Start Date" %}</label>
                <input type="datetime-local" id="start_datetime" name="start_datetime" class="form-control input-sm" value="{{ start_date }}" />
            </div>
            <div class="col-md-4 col-sm-12">
                <label for="end_datetime">{% trans "End Date" %}</label>
                <input type="datetime-local" id="end_datetime" name="end_datetime" class="form-control input-sm" value="{{ end_date }}" />
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12 col-sm-12 text-right">
                <button type="submit" class="btn btn-primary">{% trans "Search" %}</button>
            </div>
        </div>
    </form>
    <div class="row d-flex justify-content-between mt-4 same-height">
        <div class="col-md-6">
            <div class="card-body table-wrapper" style="font-size: 12px">
                <div class="table-responsive">
                    <table class="table table-sm display">
                        <thead>
                            <tr class="text-center" style="font-size: 12px">
                                <th></th>
                                <th>{% trans "Account Number" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Transfer Code" %}</th>
                                <th>{% trans "Status" %}</th>
                            </tr>
                        </thead>
                        <tbody id="inTransactionTableBody" class="text-center">
                            {% for item in in_page_obj %}
                            <tr data-toggle="collapse" data-target="#details-in-{{ forloop.counter0 }}" aria-expanded="false" aria-controls="details-in-{{ forloop.counter0 }}">
                                <td><span class="toggle-icon" id="icon-{{ item.id }}"><i class="fa fa-plus-circle" style="color: green;"></i></span></td>
                                <td>{{ item.account_number }}</td>
                                <td class="text-success">{{ item.amount|floatformat:2|intcomma }}</td>
                                <td>{{ item.transaction_date|date:"d/m/Y H:i:s" }}</td>
                                <td>{{item.transfer_code}}</td>
                                <td>{{ item.status }}</td>
                            </tr>
                            <tr class="collapse collapse-row" id="details-in-{{ forloop.counter0 }}">
                                <td colspan="6">
                                    <div>
                                        <strong>{% trans "Transaction Number" %}:</strong> {{ item.transaction_number }}<br>
                                        <strong>{% trans "Memo" %}:</strong> {{ item.description }}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Pagination for IN transactions -->
                <div class="d-flex justify-content-center">
                    <nav aria-label="In transactions page navigation">
                        <ul class="pagination" id="in-pagination">
                            {% if in_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{ in_page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </span>
                            </li>
                            {% endif %}
                            {% for num in in_page_obj.paginator.page_range %}
                                {% if num > in_page_obj.number|add:'-3' and num < in_page_obj.number|add:'3' %}
                                    {% if in_page_obj.number == num %}
                                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link" href="#" data-page="{{ num }}">{{ num }}</a></li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if in_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{ in_page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card-body table-wrapper" style="font-size: 12px">
                <div class="table-responsive">
                    <table class="table table-sm display">
                        <thead>
                            <tr class="text-center" style="font-size: 12px">
                                <th></th>
                                <th>{% trans "Account Number" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Status" %}</th>
                            </tr>
                        </thead>
                        <tbody id="outTransactionTableBody" class="text-center">
                            {% for item in out_page_obj %}
                            <tr data-toggle="collapse" data-target="#details-out-{{ forloop.counter0 }}" aria-expanded="false" aria-controls="details-out-{{ forloop.counter0 }}">
                                <td><span class="toggle-icon" id="icon-{{ item.id }}"><i class="fa fa-plus-circle" style="color: green;"></i></span></td>
                                <td>{{ item.account_number }}</td>
                                <td class="text-danger">{{ item.amount|floatformat:2|intcomma }}</td>
                                <td>{{ item.transaction_date|date:"d/m/Y H:i:s" }}</td>
                                <td>{{ item.status }}</td>
                            </tr>
                            <tr class="collapse collapse-row" id="details-out-{{ forloop.counter0 }}">
                                <td colspan="6">
                                    <div>
                                        <strong>{% trans "Transaction Number" %}:</strong> {{ item.transaction_number }}<br>
                                        <strong>{% trans "Memo" %}:</strong> {{ item.description }}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Pagination for OUT transactions -->
                <div class="d-flex justify-content-center">
                    <nav aria-label="Out transactions page navigation">
                        <ul class="pagination" id="out-pagination">
                            {% if out_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{ out_page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </span>
                            </li>
                            {% endif %}
                            {% for num in out_page_obj.paginator.page_range %}
                                {% if num > out_page_obj.number|add:'-3' and num < out_page_obj.number|add:'3' %}
                                    {% if out_page_obj.number == num %}
                                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link" href="#" data-page="{{ num }}">{{ num }}</a></li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if out_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{ out_page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    $('tr[data-toggle="collapse"]').on('click', function() {
        var targetId = $(this).data('target');
        $(targetId).collapse('toggle');
    });

    $('.collapse').on('shown.bs.collapse', function () {
        var icon = $('tr[data-target="#' + this.id + '"]').find('.toggle-icon i');
        icon.removeClass('fa-plus-circle').addClass('fa-minus-circle').css('color', 'red');
        $(this).addClass('show');
    });

    $('.collapse').on('hidden.bs.collapse', function () {
        var icon = $('tr[data-target="#' + this.id + '"]').find('.toggle-icon i');
        icon.removeClass('fa-minus-circle').addClass('fa-plus-circle').css('color', 'green');
        $(this).removeClass('show');
    });

    function fetchData(url, callback) {
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                callback(data);
            },
            error: function(xhr, status, error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    function updateTableData(tableId, data) {
        const tableBody = $('#' + tableId);
        tableBody.empty();
        data.forEach((item, index) => {
            const row = $('<tr>')
                .attr('data-toggle', 'collapse')
                .attr('data-target', `#details-${tableId}-${index}`)
                .attr('aria-expanded', 'false')
                .attr('aria-controls', `details-${tableId}-${index}`);
            
            row.append(`<td><span class="toggle-icon" id="icon-${item.id}"><i class="fa fa-plus-circle" style="color: green;"></i></span></td>`);
            row.append(`<td>${item.account_number}</td>`);
            row.append(`<td class="${item.transaction_type === 'IN' ? 'text-success' : 'text-danger'}">${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`);
            row.append(`<td>${new Date(item.transaction_date).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'medium' })}</td>`);
            if (tableId === 'inTransactionTableBody') {
                row.append(`<td>${item.transfer_code}</td>`);
            }
            row.append(`<td>${item.status}</td>`);
            tableBody.append(row);

            const detailsRow = $('<tr>')
                .addClass('collapse collapse-row')
                .attr('id', `details-${tableId}-${index}`);
            
            detailsRow.append(`<td colspan="6"><div><strong>{% trans "Transaction Number" %}:</strong> ${item.transaction_number}<br><strong>{% trans "Memo" %}:</strong> ${item.description}</div></td>`);
            tableBody.append(detailsRow);
    });

    function handlePaginationClick(event) {
        event.preventDefault();
        const page = $(this).data('page');
        if (page) {
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            params.set($(this).closest('.pagination').attr('id') === 'in-pagination' ? 'in_page' : 'out_page', page);
            url.search = params.toString();
            fetchData(url.toString(), function(data) {
                updateTableData('inTransactionTableBody', data.in_transactions);
                updateTableData('outTransactionTableBody', data.out_transactions);
                updatePagination('in-pagination', data.in_page, data.in_num_pages);
                updatePagination('out-pagination', data.out_page, data.out_num_pages);
            });
        }
    }

    function updatePagination(paginationId, currentPage, numPages) {
        const pagination = $('#' + paginationId);
        pagination.empty();
        if (currentPage > 1) {
            pagination.append(`
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `);
        } else {
            pagination.append(`
                <li class="page-item disabled">
                    <span class="page-link" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </span>
                </li>
            `);
        }
        for (let i = Math.max(1, currentPage - 2); i <= Math.min(numPages, currentPage + 2); i++) {
            pagination.append(`
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `);
        }
        if (currentPage < numPages) {
            pagination.append(`
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `);
        } else {
            pagination.append(`
                <li class="page-item disabled">
                    <span class="page-link" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </span>
                </li>
            `);
        }
        pagination.find('a.page-link').on('click', handlePaginationClick);
    }

    $('#search-form').on('submit', function(event) {
        event.preventDefault();
        const url = new URL(window.location.href);
        const params = new URLSearchParams($(this).serialize());
        fetchData(`${url.pathname}?${params.toString()}`, function(data) {
            updateTableData('inTransactionTableBody', data.in_transactions);
            updateTableData('outTransactionTableBody', data.out_transactions);
            updatePagination('in-pagination', data.in_page, data.in_num_pages);
            updatePagination('out-pagination', data.out_page, data.out_num_pages);
        });
    });

    $('a.page-link').on('click', handlePaginationClick);
});
</script>
{% endblock %}
